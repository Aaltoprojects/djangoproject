{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load bootstrap4 %}

{% block title %}
Etsi projekteja tietokannasta
{% endblock %}

{% block content %}

<div class="container">
	<div class="row justify-content-center">
		<div class="col-8">
			<h1 class="mt-2">Etsi projekti</h1>
			<hr class="mt-0 mb-4">
			<form id='search_project_form' method='get'>
				{% csrf_token %}
				<div class="row">
					<div class="col-6">
						{{ form.start_date|as_crispy_field }}
					</div>
					<div class="col-6">
						{{ form.end_date|as_crispy_field }}
					</div>
				</div>
				<div class="row">
					<div class="col-12">
						<label>
							Rakennustyyppi
						</label>
						<select class="js-example-basic-multiple" name="structure_type" multiple="multiple" style="width: 100%">
							{% for filter in f1 %}
								<option value= "{{ filter }}" > {{ filter }} </option>
							{% endfor %}
						</select>
					</div>
				</div>
				<br>
				<div class="row">
					<div class="col-12">
						<label>
							Rakennusmateriaali
						</label>
						<select class="js-example-basic-multiple" name="building_material" multiple="multiple" style="width: 100%">
							{% for filter in f2 %}
								<option value= "{{ filter }}" > {{ filter }} </option>
							{% endfor %}
						</select>
					</div>
				</div>
				<br>
				<div class="row">
					<div class="col-12">
						<label>
							Palvelu
						</label>
						<select class="js-example-basic-multiple" name="service" multiple="multiple" style="width: 100%">
							{% for filter in f3 %}
								<option value= "{{ filter }}" > {{ filter }} </option>
							{% endfor %}
						</select>
					</div>
				</div>
				<br>
				<div class="row">
					<div class="col-12">
						<label>
							Rakennustoimenpide
						</label>
						<select class="js-example-basic-multiple" name="construction_operation" multiple="multiple" style="width: 100%">
							{% for filter in f4 %}
								<option value= "{{ filter }}" > {{ filter }} </option>
							{% endfor %}
						</select>
					</div>
				</div>
				<br>
				<div class="row">
					<div class="col-12">
						<label>
							Rakenneosa
						</label>
						<select class="js-example-basic-multiple" name="structural_component" multiple="multiple" style="width: 100%">
							{% for filter in f5 %}
								<option value= "{{ filter }}" > {{ filter }} </option>
							{% endfor %}
						</select>
					</div>
				</div>
				<br>
				<div class="row">
					<div class="col-12">
						{{ form.key_phrase_search|as_crispy_field }}
					</div>
				</div>
				<button type="submit" id="search_button" class="btn btn-primary">Etsi</button>
			</form>
		</div>
	</div>
</div>

<script>
	$(document).ready(function() {
	    $('.js-example-basic-multiple').select2({
	    	theme: "bootstrap",
	    	placeholder: "Valitse yksi tai useampi"
	    });
	});
</script>

<br>

<div class="d-flex-md justify-content-center">
	<div class="ml-5 mr-5">
		<table id="project_table" class="table table-striped table-bordered display responsive" width='100%' data-order='[[ 0, "desc" ]]'>
			<thead>
			    <tr>
			        <th class='all'>Projektin nimi</th>
			        <th class='all'>Kohteen nimi</th>
			        <th class='all'>Aloituspäivä</th>
			        <th class='all'>Lopetuspäivä</th>
			        <th class='min-desktop'>Tyyppi</th>
			        <th class='min-desktop'>Materiaali</th>
			        <th class='min-desktop'>Palvelu</th>
			        <th class='min-desktop'>Toimenpide</th>
			        <th class='min-desktop'>Osa</th>
			        <th class='min-desktop'>Avainsanat</th>
			        <th class='none'>Projektin kuvaus</th>
			        <th class='none'>Polku tiedostojen sijaintiin</th>
			        <th class='none'>Projektipäällikkö</th>
			        <th class='none'>Toiminnot</th>
			    </tr>
			</thead>
			<tbody>
				{% for item in result %}
			   		<tr>
			        	<td>{{ item.project_name }}</td>
			        	<td>{{ item.destination_name }}</td>
			        	<td>{{ item.start_date|date:"d.m.Y" }}</td>
			        	<td>{{ item.end_date|date:"d.m.Y" }}</td>
			        	<td>
			        	{% for f1 in item.filters.all %}
			        		{% if f1.category == "Rakennustyyppi" %}
			        			{{ f1 }}
			        		{% endif %}
			        	{% endfor %}
			        	</td>
			        	<td>
			        	{% for f2 in item.filters.all %}
			        		{% if f2.category == "Rakennusmateriaali" %}
			        			{{ f2 }}
			        		{% endif %}
			        	{% endfor %}
			        	</td>
			        	<td>
			        	{% for f3 in item.filters.all %}
			        		{% if f3.category == "Palvelu" %}
			        			{{ f3 }}
			        		{% endif %}
			        	{% endfor %}
			        	</td>
			        	<td>
			        	{% for f4 in item.filters.all %}
			        		{% if f4.category == "Rakennustoimenpide" %}
			        			{{ f4 }}
			        		{% endif %}
			        	{% endfor %}
			        	</td>
			        	<td>
			        	{% for f5 in item.filters.all %}
			        		{% if f5.category == "Rakenneosa" %}
			        			{{ f5 }}
			        		{% endif %}
			        	{% endfor %}
			        	</td>
			        	<td>{{ item.keywords }}</td>
			        	<td>{{ item.project_description | linebreaks }}</td>
			        	<td>{{ item.documentation_path }}</td>
			        	<td>{{ item.project_manager }}</td>
			        	<td>
							<a href="edit_project/{{ item.id }}" class="btn btn-secondary">Muokkaa tietoja</a>
						</td>
			    	</tr>
			    {% endfor %}
			</tbody>
		</table>
	</div>
</div>

<script>
	$('#project_table').DataTable( {
	    language: {"url":"https://cdn.datatables.net/plug-ins/1.10.20/i18n/Finnish.json"},
	    searching: false
	} );
</script>

<script type='text/javascript'>
	$(function(){
		$('#search_button').click(function(ev){
			$.ajax({
				type: 'GET',
				url: '/search/',
				data: $('#search_project_form').serialize(),
				success: function(data, textStatus, jqXHR) {
                	console.log( "Success!" );
                	$('#project_table').html(data);
	            },
	            error: function(data, textStatus, jqXHR) {
	                console.log( "Error!" );
	            },
	            dataType: 'html'
			});
			ev.preventDefault();
		});
	});
</script>

{% endblock %}