{% load attachments_tags %}
<!doctype html>
<html lang='en'>

<div class="col-12">
    <button type="submit" id="export_button" class="btn btn-success">Vie Exceliin</button>
</div>

<br>

<div class="col-12">
    <table id="project_table" class="table table-striped table-bordered display responsive" width='100%' data-order='[[ 0, "desc" ]]'>
        <thead>
            <tr>
                <th class='all'>Projektin nimi</th>
                <th class='all'>Kohteen nimi</th>
                <th class='all'>Aloituspäivä</th>
                <th class='all'>Lopetuspäivä</th>
                <th class='min-desktop'>Tyyppi</th>
                <th class='min-desktop'>Materiaali</th>
                <th class='min-desktop'>Palvelu</th>
                <th class='min-desktop'>Toimenpide</th>
                <th class='min-desktop'>Osa</th>
                <th class='min-desktop'>Avainsanat</th>
                <th class='none'>Projektin kuvaus</th>
                <th class='none'>Polku tiedostojen sijaintiin</th>
                <th class='none'>Projektipäällikkö</th>
                <th class='none'>Projektiin liitetyt tiedostot</th>
                <th class='none'>Toiminnot</th>
            </tr>
        </thead>
        <tbody>
            {% for item in result %}
                <tr>
                    <td>
                    {% get_images_for item.id as images %}
                        {% if images %}
                            {% for image in images %}
                                <a href="{{ image.attachment_image.url }}">
                                    <img src="{{ image.attachment_image.url }}" style="width:20%;">
                                </a>
                            {% endfor %}
                        {% endif %}
                    {{ item.project_name }}
                    </td>
                    <td>{{ item.destination_name }}</td>
                    <td>{{ item.start_date|date:"d.m.Y" }}</td>
                    <td>{{ item.end_date|date:"d.m.Y" }}</td>
                    <td>
                    {% for f1 in item.filters.all %}
                        {% if f1.category == "Rakennustyyppi" %}
                            {{ f1 }}
                        {% endif %}
                    {% endfor %}
                    </td>
                    <td>
                    {% for f2 in item.filters.all %}
                        {% if f2.category == "Rakennusmateriaali" %}
                            {{ f2 }}
                        {% endif %}
                    {% endfor %}
                    </td>
                    <td>
                    {% for f3 in item.filters.all %}
                        {% if f3.category == "Palvelu" %}
                            {{ f3 }}
                        {% endif %}
                    {% endfor %}
                    </td>
                    <td>
                    {% for f4 in item.filters.all %}
                        {% if f4.category == "Rakennustoimenpide" %}
                            {{ f4 }}
                        {% endif %}
                    {% endfor %}
                    </td>
                    <td>
                    {% for f5 in item.filters.all %}
                        {% if f5.category == "Rakenneosa" %}
                            {{ f5 }}
                        {% endif %}
                    {% endfor %}
                    </td>
                    <td>{{ item.keywords }}</td>
                    <td>{{ item.project_description | linebreaks }}</td>
                    <td>{{ item.documentation_path }}</td>
                    <td>{{ item.project_manager }}</td>
                    <td>
                        {% get_attachments_for item.id as my_entry_attachments %}
                        {% if my_entry_attachments %}
                        <ul>
                        {% for attachment in my_entry_attachments %}
                            <li>
                                <a href="{{ attachment.attachment_file.url }}">
                                    <img src="{{ attachment.attachment_file.url }}" style="width:3%;">
                                    {{ attachment.filename }}
                                </a>
                            </li>
                        {% endfor %}
                        </ul>
                        {% endif %}

                    </td>
                    <td>
                        <a href="edit_project/{{ item.id }}" class="btn btn-secondary">Muokkaa tietoja</a>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    $('#project_table').DataTable( {
        language: {url:'../static/languages/Finnish.json'},
        searching: false
    } );
</script>

<script type="text/javascript">
    $('#export_button').on('click', function () {
        $.ajax({
            type: 'GET',
            url: '/export/',
            data: $('#search_project_form').serialize(),
            xhrFields: {
                responseType: 'blob'
            },
            success: function (data) {
                var a = document.createElement('a');
                var url = window.URL.createObjectURL(data);
                a.href = url;
                a.download = "results_" + today.toDateString().split(" ").join("_") + ".xls";
                document.body.append(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                console.log( "Success!" );
            },
            error: function(data) {
                console.log( "Error!" );
            },
        });
    });
</script>